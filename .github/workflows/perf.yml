name: CI - Tests & Perf Gate

on:
  push:
    branches: [ main, perf/**, "*" ]
  pull_request:
    branches: [ main ]

jobs:
  tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install pytest
      - name: Run tests
        run: |
          pytest -q

  perf-gate:
    runs-on: ubuntu-latest
    needs: tests
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      - name: Install deps (including optional numba if available)
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install pytest
          # numba is optional; install if available to CI
          pip install numba || true
      - name: Run lightweight benchmark
        run: |
          set -e
          python -m timeit -n 1 -s "from tools.run_bench import main; import time; s=time.perf_counter(); main(); print('elapsed', time.perf_counter()-s)"
      - name: Perf assertion
        run: |
          # Run the bench and assert it finishes within threshold (10s); adjust threshold as needed
          python - << 'PY'
import time
from tools.run_bench import main
s = time.perf_counter(); main(); t = time.perf_counter()-s
print('Benchmark elapsed', t)
if t > 10.0:
    raise SystemExit('Performance gate failed: benchmark took too long: %.2fs' % t)
PY